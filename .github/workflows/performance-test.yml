name: Performance Testing

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run performance tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  performance-test:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    strategy:
      matrix:
        node-version: [18, 20, 21]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run performance benchmarks
        run: |
          echo "üöÄ Running performance benchmarks..."
          npm run benchmark:all

      - name: Run performance monitoring
        run: |
          echo "üìä Running performance monitoring..."
          npm run monitor:all

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results-node-${{ matrix.node-version }}
          path: |
            benchmark-results.json
            performance-metrics.json

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const benchmarkResults = JSON.parse(fs.readFileSync('benchmark-results.json', 'utf8'));
              const performanceMetrics = JSON.parse(fs.readFileSync('performance-metrics.json', 'utf8'));
              
              const comment = `## üìä Performance Test Results
              
              ### üöÄ Installation Speed
              | Method | Avg Time | Min Time | Max Time | Avg Size | Success Rate |
              |--------|----------|----------|----------|----------|--------------|
              ${Object.entries(benchmarkResults.summary).map(([method, stats]) => 
                `| ${method} | ${stats.avgDuration.toFixed(0)}ms | ${stats.minDuration.toFixed(0)}ms | ${stats.maxDuration.toFixed(0)}ms | ${(stats.avgSize / 1024 / 1024).toFixed(1)}MB | ${stats.successRate.toFixed(0)}% |`
              ).join('\n')}
              
              ### üì¶ Build Performance
              - **Total Operations**: ${performanceMetrics.summary.totalOperations}
              - **Total Duration**: ${performanceMetrics.summary.totalDuration.toFixed(2)}ms
              - **Average Duration**: ${performanceMetrics.summary.averageDuration.toFixed(2)}ms
              - **Memory Peak**: ${(performanceMetrics.summary.memoryPeak / 1024 / 1024).toFixed(1)}MB
              
              ### üéØ Performance Targets
              - ‚úÖ Core Installation: < 15s
              - ‚úÖ Full Installation: < 45s
              - ‚úÖ NPX Execution: < 10s
              - ‚úÖ Docker Build: < 120s
              - ‚úÖ Bundle Size: < 1MB (core)
              
              <details>
              <summary>üìã Detailed Results</summary>
              
              \`\`\`json
              ${JSON.stringify(benchmarkResults, null, 2)}
              \`\`\`
              </details>`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not generate performance comment:', error.message);
            }

  performance-regression:
    runs-on: ubuntu-latest
    needs: performance-test
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download baseline results
        run: |
          # Download baseline performance results from main branch
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3.raw" \
            -o baseline-results.json \
            "https://api.github.com/repos/${{ github.repository }}/contents/performance-baseline.json"
        continue-on-error: true

      - name: Run current benchmarks
        run: npm run benchmark:all

      - name: Compare performance
        run: |
          if [ -f baseline-results.json ]; then
            echo "üìä Comparing performance with baseline..."
            node scripts/compare-performance.js baseline-results.json benchmark-results.json
          else
            echo "‚ö†Ô∏è No baseline found, skipping comparison"
          fi
        continue-on-error: true

      - name: Fail on significant regression
        run: |
          if [ -f performance-comparison.json ]; then
            node scripts/check-regression.js performance-comparison.json
          fi
